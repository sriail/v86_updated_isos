<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V86 Emulator - Multiple OS Options</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Preload critical resources for faster boot -->
    <link rel="preload" href="lib/v86.wasm" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="lib/seabios.bin" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="lib/vgabios.bin" as="fetch" crossorigin="anonymous">
    <link rel="modulepreload" href="lib/libv86.mjs">
</head>
<body>
    <div class="container">
        <header>
            <h1>V86 x86 Emulator</h1>
            <p class="subtitle">Multiple Operating Systems</p>
            <div class="library-selector">
                <label for="v86-library-select">V86 Library:</label>
                <select id="v86-library-select">
                    <option value="v86" selected>V86 (Standard)</option>
                    <option value="v86_modern">V86 Modern (@sriail/v86_modern)</option>
                </select>
                <span class="library-info" title="Select which v86 library to use. Change requires page reload." aria-label="Library selector information">ℹ️</span>
            </div>
        </header>

        <div class="settings-panel">
            <h3>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
                VM Settings
            </h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="ram-setting">RAM (MB):</label>
                    <input type="number" id="ram-setting" min="64" max="4096" value="128" step="64">
                </div>
                <div class="setting-item">
                    <label for="vram-setting">VRAM (MB):</label>
                    <input type="number" id="vram-setting" min="2" max="256" value="8" step="2">
                </div>
                <div class="setting-item">
                    <label for="iso-select">ISO:</label>
                    <select id="iso-select">
                        <option value="">None (Boot to BIOS)</option>
                        <option value="https://archive.org/download/tinycore-linux-13.1/TinyCore-13.1.iso" selected>TinyCore Linux 13.1</option>
                        <option value="https://archive.org/download/slitaz-5.0/slitaz-5.0.iso">SliTaz 5.0</option>
                        <option value="https://archive.org/download/slitaz-rolling-core-5in1/slitaz-rolling-core-5in1.iso">SliTaz Rolling Core 5in1</option>
                        <option value="https://archive.org/download/bodhi-5.1.0-legacy/bodhi-5.1.0-legacy.iso">Bodhi Linux 5.1.0 Legacy</option>
                        <option value="https://archive.org/download/ReactOS_0.4.14/ReactOS-0.4.14-release-106-gdb1c396-live.iso">ReactOS 0.4.14</option>
                        <option value="https://archive.org/download/nanolinux-1.4/nanolinux-1.4.iso">NanoLinux 1.4</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label for="audio-enabled">Audio:</label>
                    <input type="checkbox" id="audio-enabled" checked>
                    <label for="audio-enabled" style="font-weight: normal; margin-left: 5px;">Enable Sound</label>
                </div>
                <div class="setting-item">
                    <label for="screen-scale">Screen Scale:</label>
                    <select id="screen-scale">
                        <option value="1">100%</option>
                        <option value="1.25">125%</option>
                        <option value="1.5">150%</option>
                        <option value="2">200%</option>
                        <option value="fit">Fit to Window</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="start-btn" class="btn" title="Start Emulator">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                Start
            </button>
            <button id="stop-btn" class="btn" title="Stop Emulator" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="6" width="12" height="12"/>
                </svg>
                Stop
            </button>
            <button id="reset-btn" class="btn" title="Reset Emulator" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
                </svg>
                Reset
            </button>
            <button id="pause-btn" class="btn" title="Pause/Resume Emulator" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
                </svg>
                Pause
            </button>
            <button id="fullscreen-btn" class="btn" title="Toggle Fullscreen" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                Fullscreen
            </button>
            <button id="cursor-lock-btn" class="btn" title="Lock/Unlock Cursor" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13.64,21.97C13.14,22.21 12.54,22 12.31,21.5L10.13,16.76L7.62,18.78C7.45,18.92 7.24,19 7,19A1,1 0 0,1 6,18V3A1,1 0 0,1 7,2C7.24,2 7.47,2.09 7.64,2.23L7.65,2.22L19.14,11.86C19.57,12.22 19.62,12.85 19.27,13.27C19.12,13.45 18.91,13.57 18.7,13.61L15.54,14.23L17.74,18.96C18,19.46 17.76,20.05 17.26,20.28L13.64,21.97Z"/>
                </svg>
                Lock Cursor
            </button>
            <button id="screenshot-btn" class="btn" title="Take Screenshot" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="3.2"/>
                    <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                </svg>
                Screenshot
            </button>
            <button id="save-state-btn" class="btn" title="Save State" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                Save
            </button>
            <button id="restore-state-btn" class="btn" title="Restore State" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
                Restore
            </button>
            <button id="import-iso-btn" class="btn" title="Import ISO/Image">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                </svg>
                Import
            </button>
            <button id="export-state-btn" class="btn" title="Export State" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                </svg>
                Export
            </button>
            <button id="dump-memory-btn" class="btn" title="Dump Memory" disabled>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15,9H9v6h6V9z M13,13h-2v-2h2V13z"/>
                    <path d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                </svg>
                Dump Memory
            </button>
        </div>
        <input type="file" id="file-input" accept=".iso,.img,.state" style="display: none;">

        <div class="emulator-container">
            <div id="screen_container">
                <div style="white-space: pre; font: 14px monospace; line-height: 14px"></div>
                <canvas id="screen"></canvas>
            </div>
        </div>

        <!-- Mouse Lock Confirmation Dialog -->
        <div id="mouse-lock-dialog" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Mouse Lock Requested</h3>
                <p>The VM wants to lock your mouse cursor. Your mouse will be confined to the emulator window.</p>
                <p><strong>Press ESC to unlock the mouse at any time.</strong></p>
                <div class="modal-checkbox">
                    <label>
                        <input type="checkbox" id="mouse-lock-dont-show">
                        Do not show me again
                    </label>
                </div>
                <div class="modal-actions">
                    <button id="mouse-lock-proceed" class="btn">Proceed</button>
                    <button id="mouse-lock-cancel" class="btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Network Settings -->
        <div class="network-panel">
            <h3>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17,3A2,2 0 0,1 19,5V15A2,2 0 0,1 17,17H13V19H14A1,1 0 0,1 15,20H22V22H15A1,1 0 0,1 14,23H10A1,1 0 0,1 9,22H2V20H9A1,1 0 0,1 10,19H11V17H7C5.89,17 5,16.1 5,15V5A2,2 0 0,1 7,3H17M17,5H7V15H17V5Z"/>
                </svg>
                Network Configuration
            </h3>
            <div class="network-settings">
                <div class="setting-item">
                    <label for="network-mode">Network Mode:</label>
                    <select id="network-mode">
                        <option value="none">None (No Network)</option>
                        <option value="wisp">WISP Server (WebSocket Proxy)</option>
                        <option value="host" selected>Host Connection (Use Host Internet)</option>
                    </select>
                </div>
                <div class="setting-item" id="wisp-url-container" style="display: none;">
                    <label for="wisp-url">WISP Server URL:</label>
                    <input type="text" id="wisp-url" placeholder="wss://wisp.example.com" value="">
                </div>
                <div class="setting-item" id="relay-url-container" style="display: block;">
                    <label for="relay-url">Relay Server URL:</label>
                    <input type="text" id="relay-url" placeholder="ws://localhost:8000" value="ws://localhost:8000">
                </div>
                <div class="network-info">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                    </svg>
                    <div>
                        <strong>Network Info:</strong>
                        <ul>
                            <li><strong>None:</strong> VM has no network connectivity</li>
                            <li><strong>WISP Server:</strong> Connect through WebSocket proxy server (requires WISP.js compatible server)</li>
                            <li><strong>Host Connection:</strong> Use browser's network connection (requires relay configuration)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="metrics">
            <div class="metric-group">
                <h3>Performance Metrics</h3>
                <div class="metric-grid">
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l2.6 1.53c.56-1.24.88-2.62.88-4.07 0-5.18-3.95-9.45-9-9.95zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05c-5.06.5-9 4.76-9 9.95 0 5.52 4.47 10 9.99 10 3.31 0 6.24-1.61 8.06-4.09l-2.6-1.53C16.17 17.98 14.21 19 12 19z"/>
                        </svg>
                        <span class="metric-label">Speed:</span>
                        <span id="speed-metric" class="metric-value">0 MIPS</span>
                    </div>
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>
                        </svg>
                        <span class="metric-label">Memory:</span>
                        <span id="memory-metric" class="metric-value">0 MB</span>
                    </div>
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <span class="metric-label">Instructions/sec:</span>
                        <span id="ips-metric" class="metric-value">0</span>
                    </div>
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <span class="metric-label">Status:</span>
                        <span id="status-metric" class="metric-value">Not running</span>
                    </div>
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                        </svg>
                        <span class="metric-label">Uptime:</span>
                        <span id="uptime-metric" class="metric-value">0s</span>
                    </div>

                </div>
            </div>

            <div class="metric-group">
                <h3>Resource Consumption</h3>
                <div class="metric-grid">
                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15,9H9v6h6V9z M13,13h-2v-2h2V13z"/>
                            <path d="M21,3H3C1.9,3,1,3.9,1,5v14c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V5C23,3.9,22.1,3,21,3z M21,19H3V5h18V19z"/>
                        </svg>
                        <span class="metric-label">RAM Allocated:</span>
                        <span id="ram-allocated" class="metric-value">0 MB</span>
                    </div>

                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/>
                        </svg>
                        <span class="metric-label">VRAM Allocated:</span>
                        <span id="vram-allocated" class="metric-value">0 MB</span>
                    </div>

                    <div class="metric-item">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>
                        </svg>
                        <span class="metric-label">Storage Used:</span>
                        <span id="storage-used" class="metric-value">0 MB</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="log-section">
            <h3>
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z"/>
                </svg>
                Console Log
            </h3>
            <div id="log" class="log-content"></div>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
